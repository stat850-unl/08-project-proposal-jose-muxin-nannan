---
title: "Football analysis"
output: html_document
---

```{r}
# Libraries used
library(dplyr)
library(tidyverse)
library(tidyr)
```

## Part A: Prepare the data for analysis

### 1, Read in data

```{r}
# #install package 'xlsx' if not installed yet
# if (!"xlsx" %in% installed.packages()) install.packages('xlsx')
# library('xlsx')
# 
# #read in data sheets
# sheet.index <- 1:3
# data.list <- list()
# for(i in sheet.index)
#   data.list[[i]]<-read.xlsx('football_salaries.xls', sheetIndex = i)
# 
# # Rename the datasets as we wanted
# player_salary <- data.list[[1]]
# coach_salary <- data.list[[2]]
# coach_record <- data.list[[3]]
```

Read from different files
```{r}
player_salary <- read.csv('player_salary.csv',
                    header = TRUE,
                    sep = ',')
coach_salary <- read.csv('coach_salary.csv',
                    header = TRUE,
                    sep = ',')
coach_record <- read.csv('coach_record.csv',
                    header = TRUE,
                    sep = ',')
```

### 2, Cleaning data

#### 2.1 General information of the datasets

We first take a brief look at the datasets of their descriptive statistics.

```{r}
summary(player_salary)
summary(coach_salary)
summary(coach_record)
```

Check if there are Na values.

```{r}
# Check if there are NA values
for (i in sheet.index){
  print(data.list[[i]] %>% is.na() %>% sum())
}
```

We see there are some cleaning should be done before we can use these datasets:\
1. Take care of the missing value in **coach_salaries**\
2. Change the column names in **coach_record**\
3. For consistency, change salary-related variable types to double in **coach_salary** and **coach_record**.\
4. Separate variables if needed.

##### 2.1.1. missing values

```{r}
# replicate the original model for cleaning
player_salary_ <- player_salary
coach_salary_ <- coach_salary
coach_record_ <- coach_record

# Finding the missing value, and filled in with internet searching result
coach_salary_ <- coach_salary
coach_salary_[c(which(is.na(coach_salary)==TRUE, arr.ind = TRUE)[,1]),5] <- '2.5 million'
```

##### 2.1.2 Fix column names

```{r}
colnames(coach_record_) <- c(coach_record_[1,])
coach_record_ <- coach_record_[-1,]
rownames(coach_record_) <- c(1:nrow(coach_record_))

colnames(coach_salary_) <- c(colnames(coach_salary_)[1:3], 'Annual_salary', 'Net_worth', colnames(coach_salary_)[6])
```

##### 2.1.3 change the variable type

2.1.3.1. **coach_salary**  
* *Annual_salary*

```{r}
# get the index of the cells with out 'million'
no_mill <- c(which(!agrepl('million', coach_salary_$Annual_salary, ignore.case = T)))

# paste 'million' to uniform these cells
for (i in no_mill)
  coach_salary_[i,'Annual_salary'] <- paste(coach_salary_[i,'Annual_salary'], 'million', collapse = ' ')

# separate the numeric parts and drop million
coach_salary_ <- separate(coach_salary_, Annual_salary, c('income', NA), ' ')

# Keep numeric parts and change variable type to numeric
for (i in 1:nrow(coach_salary_))
  coach_salary_[i,'income'] <-
substr(coach_salary_[i, 'income'], 2, nchar(coach_salary_[i,'income']))

# numerize the variable
for (i in 1:nrow(coach_salary_)){
  if (i %in% no_mill)
    coach_salary_[i, 'income'] <- as.double(gsub(',', '', coach_salary_[i,'income']))
  if (i==24)
      coach_salary_[i, 'income'] <- as.double(substr(coach_salary_[i, 'income'], 1, (nchar(coach_salary_[i,'income'])-1)))
  else
    coach_salary_[i, 'income'] <- as.double(coach_salary_[i, 'income'])*1000000
}
coach_salary_ <- rename(coach_salary_, 'Annual_salary'='income')
```

* *Net_salary*

```{r warning=FALSE}
# Remove dollar sign and trim
for (i in 1:nrow(coach_salary_)){
  coach_salary_[i, 'Net_worth'] <- gsub('\\$', '', coach_salary_[i, 'Net_worth'])
  coach_salary_[i, 'Net_worth'] <- gsub(' ' , '', coach_salary_[i, 'Net_worth'])
}

coach_salary_ <- separate(coach_salary_, Net_worth, c('net', NA), 'million')

coach_salary_$net <- as.double(coach_salary_$net)*1000000

coach_salary_ <- rename(coach_salary_, 'Net_worth'='net')
```

2.1.3.2 **coach_record**

```{r}
for (i in 4:ncol(coach_record_))
  coach_record_[,i] <- as.double(coach_record_[,i])
```

##### 2.1.4. Separate variables

-   **player_salary**

```{r warning=FALSE}

player_salary_ <- player_salary %>% separate(free_agency, c('agency_time', 'type'),' ')
# There's warning of NA's in the dataset

# Extract rows with NA values
player_salary_[c(which(is.na(player_salary_)==TRUE, arr.ind = TRUE)[,1]),]

# These are not top players
# the number of missing data is not very large, so we just drop  them
player_salary_ <- player_salary_[-c(which(is.na(player_salary_)==TRUE, arr.ind = TRUE)[,1]) ,]
rownames(player_salary_) <- c(1:nrow(player_salary_))

player_salary_$agency_time <- as.numeric(player_salary_$agency_time)
```

#### 2.1.5, Fix abnormal data

Replace age larger than 50 or smaller than 15 with mean age of the rest age data.

```{r}
age_mean <- player_salary_ %>% filter(age>15) %>% filter(age<50) %>% select(age)%>% summarize_each(funs(mean))

player_salary_[player_salary_$age < 15, 'age'] <- age_mean
player_salary_[player_salary_$age > 50, 'age'] <- age_mean
```

There are three 0 values in *avg_year*, so we just delete them.

```{r}
player_salary_ <- player_salary_[player_salary_$avg_year != 0,]
```
#### 2.1.6, Repeated variable
There were few positions in **player_salary** are the same, merge them as needed:
(1) **3-4-defensive-end** and **4-3-denfensive-end**  
(2) **3-4-denfensive-tackle** and **4-3-defensive-tackle** (both belong to **defensive-line**)  
(3) **linebacker**, **traditional-linebacker**, and **insider-linebacker**  
(4) **3-4-outside-linebacker** and **4-3-outside-linebacker** 
There are some positions belongs to the other, they are:  
**cornerback** and **safty** belong to **defensive-back**   
**center** belong to **offensive-line**  
**3-4-denfensive-tackle** and **4-3-defensive-tackle** (both belong to **defensive-line**)  

```{r}
player_salary_[player_salary_$position=='3-4-defensive-end','position'] <- '4-3-defensive-end'

player_salary_[player_salary_$position=="3-4-defensive-tackle",'position'] <- "4-3-defensive-tackle"

player_salary_[player_salary_$position=='traditional-linebacker','position'] <- "linebacker"
player_salary_[player_salary_$position=="inside-linebacker",'position'] <- "linebacker"

player_salary_[player_salary_$position=='3-4-outside-linebacker','position'] <- '4-3-outside-linebacker'
```
```{r}
unique(player_salary_$position)
unique(football_salaries$age)

```


Here is the data we eventually have:
```{r}
player_salary <- player_salary_
coach_record <- coach_record_
coach_salary <- coach_salary_
```


## Topics and Analysis

#### Jose

# 5. How many players will be free agency by 2022?

```{r}
# Importing package
library(readxl)
library(stringr)

# Loading dataframe
df_salaries <- read_excel("football_salaries.xls")

# Removing strings from column 
df_salaries$free_agency <- substr(df_salaries$free_agency, 0, 4)
df_salaries <- df_salaries[df_salaries$free_agency != NaN,]

# Cheking how many player will be free agency by 2022
df_salaries$free_agency <- as.numeric(df_salaries$free_agency)
df_free <- df_salaries %>% dplyr::filter(free_agency >= 2022)
nrow(df_free)

# Plotting
df_agency <- df_salaries
df_agency$free_agency <- as.factor(df_salaries$free_agency)

ggplot(df_agency, aes(x= free_agency, color="free_agency")) +
    geom_bar(stat = "count", fill="white") +
    labs(x = "Free Agency") +
  #ylim(0, 2500) +
  scale_y_continuous(breaks = seq(0, 2500, by = 250))
  ggtitle("Number of players by free agency years")
```

There will be 2208 free agency players by 2022 \# 6. What are the 20 MVP players based on their earns?

```{r}
# Creating column with MVP value 
df_MVP <- df_salaries %>% 
  rowwise() %>% 
  mutate(MVP_value = sum(avg_year, total_guaranteed, fully_guaranteed))

# Removing duplicated players'name
df_MVP <- df_MVP %>% distinct(player, .keep_all= TRUE)
# Organizing it by sorting as ascending values
df_MVP <- df_MVP[order(df_MVP$MVP_value),]
# Extracting the 20 highest MVP_values
df_20 <- tail(df_MVP, n= 20)
# The 20 most valuable players (MVP) are:
df_20$player
# Which position has more MVP's?
df_20$position <- as.factor(df_20$position) # making position as factor

# Removing duplicated players'name
df_MVP <- df_MVP %>% distinct(player, .keep_all= TRUE)

# Organizing it by sorting as ascending values
df_MVP <- df_MVP[order(df_MVP$MVP_value),]

# Extracting the 20 highest MVP_values
df_20 <- tail(df_MVP, n= 20)

# The 20 most valuable players (MVP) are:
df_20$player

# Which position has more MVP's?
df_20$position <- as.factor(df_20$position) # making position as factor

ggplot(df_20, aes(x= position, color= position)) +
    geom_bar(stat = "count") +
    labs(x = "Position") +
  ggtitle("MVP's per position")
```

The position that shows more MVP's is the quarterback.

# 7. What teams have the highest fully guaranteed expenses?

```{r}
# Grouping by teams
library(dplyr)
df_fully <- df_salaries %>% group_by(team) %>% dplyr::summarize(fully_guaranteed_mean=(mean(fully_guaranteed)))

ggplot(df_salaries, aes(x= team, y=fully_guaranteed)) +
    geom_bar() +
    labs(x = "Position") +
  ggtitle("MVP's per position")
```

The Bears team has the highest fully guaranteed expenses (4226673 dollars), followed by Red Skins (4018702 dollars) and Browns (3886874).

# 8. What is the relationship between coach salaries and their records?

## Part B: Data analysis  
### 1, What are the variables related to high salary of players?
As the dataset is related to the income or value of a player, so the first question we care about is what makes their income so different. Basing on the variables in the data, we propose following:
#### 1.1 position
Position is the most intuitively reason we would associate with income -- there are positions more important in a game, they are supposed to make more money. We first take a look at the average levels of all positions.
##### 1.1.1 Average highest
```{r warning=FALSE}
# unique(player_salary$position)#24 positions in the data

# Select columns of position, avg_year, player to find positions with the highest salary

position_sub<- player_salary[c('position','avg_year')]%>%
  group_by(position)

p <- position_sub %>%
      summarize_each(funs(mean)) %>%
      arrange(desc(avg_year)) %>%
      head(10) %>%
      select(position) %>%
      inner_join(position_sub, by='position') %>% 
      group_by(position) %>%
      ggplot(aes(x=position, y=avg_year))+
      geom_boxplot(aes(fill=avg_year)) +
      theme(axis.text.x = element_text(angle=90, hjust = 1))
p + stat_summary(fun=mean, color='darkred', geom='point') #red dot identifies the mean value
```
If we look at the number of positions by `unique()`, we see there are 24 positions, but we are concentrating on the highest ones, so I keep the top 10 average salary positions to display in the plot. Red dot in the plot identifies the average value. 
Though the boxplot quartiles are scaled by large outliers, the position with the highest yearly pay is **quarterback**. To clear see the tendency, zoom in to see the average values.

```{r}
p + stat_summary(fun=mean, color='darkred', geom='point') +
    coord_trans(x = "identity", y = "identity", xlim = NULL, ylim = c(0,6e+6))

```
If we look at this zoomed in plot, we find the avarage annual salary of quarterback is getting close to 6 million, which could be twice of the number of 4-3 outside linebacker.
If we take a closer look at the boxplot, we find all the medians are close to the bottom of the box, which means very few of the players get extraordinarily high annual income, so we want to know how are these extraordinarily high annual income relatted to the position.

##### 1.1.2 Top highest in each position

We have known that the highest average is **quarterback**, but as mentioned above, the medians are not as much different as averages. The "outliers" (or highest paid players) make this discrepancy, so we would like to take a look at the top 10 outliers for each group.

```{r}
top_10_each_position <- position_sub %>%
                          summarize_each(funs(mean)) %>%
                          arrange(desc(avg_year)) %>%
                          head(10) %>%
                          select(position) %>%
                          inner_join(position_sub, by='position') %>% 
                          group_by(position) %>%
                          slice_max(order_by = avg_year, n = 10)

ggplot(top_10_each_position, aes(x=position, y=avg_year))+
      geom_boxplot() +
      theme(axis.text.x = element_text(angle=90, hjust = 1))

```

This plots shows that even in the most-paid subset, **quarterback** has the obvious highest yearly pay. If we look at the overall trend of each position, they almost follow the same trend we had in the previous boxplot of everage yearly salary.

#### 1.2 age

Another factor could matters to salary could be age. It is conceivable that a player at younger age tend to be more energetic and active while older players are more experience at team-work and techniques, so there could be an optimum age preferred by clubs and willing to pay more.

To look at if age affect salary, we will first look at the most paid players in each position to see their age distribution.
```{r}
player_salary %>% group_by(position) %>% slice_max(order_by = avg_year, n = 10) %>%
  ggplot(aes(x=age)) + 
  geom_histogram(binwidth = 2,
                 color='black',
                 fill='white')+
   geom_density() +
   geom_density(alpha=.2, fill='#FF6666')+
   geom_vline(aes(xintercept=mean(age, na.rm=T)),
               color="red", linetype="dashed", size=1) #red dash is the mean
```
This plot has bin width of 2, and the red dashed line marks the median of the distribution. We see that the 
We can tell that the age of most top-paid players are concentrated around 26, and the overall distribution is slightly right-skewed.

```{r}
player_salary %>%
  ggplot(aes(x=age)) + 
  geom_histogram(binwidth = 2,
                 color='black',
                 fill='white')+
   # geom_density(alpha=.2, fill="#FF6666")+
   geom_vline(aes(xintercept=mean(age, na.rm=T)),
               color="red", linetype="dashed", size=1)
```

The overall age distribution has a very similar tendency to the top-paid one, the right-skewness is easier to identify. 30 seems like a division -- the number of frequency drops drasctially after 30.

#### team

To look at the effect of team, we will look at both highest paid positions for each team and average pay for each team.

```{r}
# Average
# head(player_salary)
# player_salary %>% group_by(team) %>% select(c('team','avg_year')) %>% summarize_each(funs(mean)) %>%
#   ggplot(aes(x=team))+geom_boxplot() + theme(axis.text.x = element_text(angle=90, hjust = 1))

p <-player_salary[,c('team','avg_year')] %>% group_by(team) %>%
      summarize_each(funs(mean)) %>%
      arrange(desc(avg_year)) %>%
head(32) %>%
select(team) %>%
inner_join(player_salary[,c('team','avg_year')], by='team') %>%
group_by(team)%>%
ggplot(aes(x=team, y=avg_year))+
geom_boxplot(aes(fill=avg_year))+
theme(axis.text.x = element_text(angle=90, hjust = 1))
p + stat_summary(fun=mean, color='darkred', geom='point') #red dot identifies the mean value
```

There are some fluctuations, zoom in to identify the tendency.

```{r}
p + stat_summary(fun=mean, color='darkred', geom='point') +
    coord_trans(x = "identity", y = "identity", xlim = NULL, ylim = c(0,4e+6))
```

Unlike the position, there is not an outstanding best-paid team, rather, there are few less-paid teams, so let's look at the bar plot.

```{r}
less_team <- player_salary[,c('team','avg_year')] %>% 
      group_by(team) %>%
      summarize_each(funs(mean)) %>%
      arrange(avg_year) %>%
      head(16) %>%
      select(team) %>%
      inner_join(player_salary[,c('team','avg_year')], by='team') %>%
      group_by(team) %>% 
      summarize_each(funs(mean)) %>% 
      mutate(Rate='Lo')
hi_team <- player_salary[,c('team','avg_year')] %>% 
      group_by(team) %>%
      summarize_each(funs(mean)) %>%
      arrange(desc(avg_year)) %>%
      head(16) %>%
      select(team) %>%
      inner_join(player_salary[,c('team','avg_year')], by='team') %>%
      group_by(team) %>% 
      arrange(desc(avg_year)) %>%  
      summarize_each(funs(mean)) %>%
      mutate(Rate='Hi')
hi_low_team <- rbind(hi_team, less_team)

ggplot(hi_low_team, aes(x=team, y=avg_year))+
  theme(axis.text.x = element_text(angle=90, hjust = 1))+
  geom_bar(stat = 'identity')
  # facet_grid(. ~ Rate)
```

The *Cowboy*, *Rams* obviously has lower average salary than the other teams. We know that *headquarter* is the position to have higher salary, so we want to know if these teams are paying lower salary depends on positions.

```{r}
all_team <- player_salary[,c('avg_year', 'position')]  %>% 
                group_by(position) %>%
                summarise_each(funs(mean))%>%
                mutate(Distr = 'All')

Cowboy_team <- 
            player_salary[player_salary$team=='Cowboys' ,c('avg_year', 'position')]%>% 
                group_by(position) %>%
                summarise_each(funs(mean))%>%
                mutate(Distr ='Cowboy')

Rams_team <- player_salary[player_salary$team=='Rams' ,c('avg_year', 'position')] %>% 
                group_by(position) %>%
                summarise_each(funs(mean))%>%
                mutate(Distr ='Rams') 

position_team <- rbind(all_team, Cowboy_team, Rams_team)
ggplot(position_team, aes(x=position, y=avg_year))+
  theme(axis.text.x = element_text(angle=90, hjust = 1))+
  geom_bar(stat = 'identity')+
  facet_grid(Distr ~ .)
```

Interestingly, neither of these follow the overall trend, but they both follow the same pattern: paying more to *4-3 defensive-tackle* and *left-tackle*.

## NanNan
![cover](GoBigRed.png)
![Stadium](Stadium.jpg)
![team](team.jpg)
![football positions](footballPosition.png)



```{r}
# average salary of each position
posSa <- football %>% group_by(football$position) %>%
  summarise(avg <- mean(total_value))
posSa <- as.data.frame(posSa)
posSa[order(posSa$`avg <- mean(total_value)`,decreasing=T),]
```

quarterback is the position that makes the most money across all positions
```{r}
library(tidyverse)
# number of players of each position
frequency <- player_salary_ %>% group_by(player_salary_$position)%>%
  summarise(n = n())
frequency <- as.data.frame(frequency)
frequency[order(frequency$n,decreasing = T),]
```

defensive-back is the position that has the most players across all positions; offensive-line is the position that has the second most players.

```{r}
# average salary of each team
teamSa <- player_salary_  %>% group_by(player_salary_ $team) %>%
  summarise(avg <- mean(total_value))
teamSa <- as.data.frame(teamSa)
teamSa[order(teamSa$`avg <- mean(total_value)`,decreasing=T),]
```

players in Vikings make the most across all teams.

```{r}
# average salary of each age group
unique(player_salary$age)
ageSa <- player_salary_  %>% group_by(player_salary_ $age) %>%
  summarise(avg <- mean(total_value))
ageSa <- as.data.frame(ageSa)
ageSa[order(ageSa$`avg <- mean(total_value)`,decreasing=T),]
```

players older than 30 could make much more than those younger than 30

```{r}
# age and total value correlation
cor(player_salary_ $total_value,player_salary_ $age)
corAge <- ggplot(data=player_salary_ ,aes(x=age,y=total_value))+xlim(0, 70)+geom_point(color ="darkgreen")
corAge
```

It shows that age is positively correlated with salary but it's not strong correlation;
From the scatter plot, we could see that players with age around 30 make more money compared to other age groups, which is consistent with finding from previous part. 

```{r}
# is total value positively correlated with fully guaranteed?
cor(player_salary_ $total_value,player_salary_ $fully_guaranteed)
corValue <- ggplot(data=player_salary_ ,aes(x=total_value,y=fully_guaranteed))+
  geom_point(color ="darkgreen")
corValue
```

It shows that total_value and fully_guaranteed are highly correlated.
