---
title: "Football analysis"
output: html_document
---
```{r}
# Libraries used
library(dplyr)
library(tidyverse)
library(tidyr)
```



## Prepare the data for analysis
### Read in data
```{r}
#install package 'xlsx' if not installed yet
if (!"xlsx" %in% installed.packages()) install.packages('xlsx')
library('xlsx')

#read in data sheets
sheet.index <- 1:3
data.list <- list()
for(i in sheet.index)
  data.list[[i]]<-read.xlsx('football_salaries.xls', sheetIndex = i)

# Rename the datasets as we wanted
player_salary <- data.list[[1]]
coach_salary <- data.list[[2]]
coach_record <- data.list[[3]]
```

### Cleaning data
#### General information of the datasets
We first take a brief look at the datasets of their descriptive statistics.
```{r}
summary(player_salary)
summary(coach_salary)
summary(coach_record)
```
Check if there are Na values.
```{r}
# Check if there are NA values
for (i in sheet.index){
  print(data.list[[i]] %>% is.na() %>% sum())
}
```
We see there are some cleaning should be done before we can use these datasets:  
1. Take care of the missing value in **coach_salaries**  
2. Change the column names in **coach_record**  
3. For consistency, change salary-related variable types to double in **coach_salary** and **coach_record**.    
4. Separate variables if needed.  

##### 1. missing values
```{r}
# replicate the original model for cleaning
player_salary_ <- player_salary
coach_salary_ <- coach_salary
coach_record_ <- coach_record

# Finding the missing value, and filled in with internet searching result
coach_salary_ <- coach_salary
coach_salary_[c(which(is.na(coach_salary)==TRUE, arr.ind = TRUE)[,1]),5] <- '2.5 million'
```

##### 2 Fix column names
```{r}
colnames(coach_record_) <- c(coach_record_[1,])
coach_record_ <- coach_record_[-1,]
rownames(coach_record_) <- c(1:nrow(coach_record_))

colnames(coach_salary_) <- c(colnames(coach_salary_)[1:3], 'Annual_salary', 'Net_worth', colnames(coach_salary_)[6])
```

##### 3 change the variable type   
3.1. **coach_salary**
* *Annual_salary*
```{r}
# get the index of the cells with out 'million'
no_mill <- c(which(!agrepl('million', coach_salary_$Annual_salary, ignore.case = T)))

# paste 'million' to uniform these cells
for (i in no_mill)
  coach_salary_[i,'Annual_salary'] <- paste(coach_salary_[i,'Annual_salary'], 'million', collapse = ' ')

# separate the numeric parts and drop million
coach_salary_ <- separate(coach_salary_, Annual_salary, c('income', NA), ' ')

# Keep numeric parts and change variable type to numeric
for (i in 1:nrow(coach_salary_))
  coach_salary_[i,'income'] <-
substr(coach_salary_[i, 'income'], 2, nchar(coach_salary_[i,'income']))

# numerize the variable
for (i in 1:nrow(coach_salary_)){
  if (i %in% no_mill)
    coach_salary_[i, 'income'] <- as.double(gsub(',', '', coach_salary_[i,'income']))
  if (i==24)
      coach_salary_[i, 'income'] <- as.double(substr(coach_salary_[i, 'income'], 1, (nchar(coach_salary_[i,'income'])-1)))
  else
    coach_salary_[i, 'income'] <- as.double(coach_salary_[i, 'income'])*1000000
}
coach_salary_ <- rename(coach_salary_, 'Annual_salary'='income')
```

* *Net_salary*
```{r}
# Remove dollar sign and trim
for (i in 1:nrow(coach_salary_)){
  coach_salary_[i, 'Net_worth'] <- gsub('\\$', '', coach_salary_[i, 'Net_worth'])
  coach_salary_[i, 'Net_worth'] <- gsub(' ' , '', coach_salary_[i, 'Net_worth'])
}

coach_salary_ <- separate(coach_salary_, Net_worth, c('net', NA), 'million')

coach_salary_$net <- as.double(coach_salary_$net)*1000000

coach_salary_ <- rename(coach_salary_, 'Net_worth'='net')
```

3.2 **coach_record**
```{r}
for (i in 4:ncol(coach_record_))
  coach_record_[,i] <- as.double(coach_record_[,i])
```

##### 4. Separate variables  
* **player_salary**
```{r}

player_salary_ <- player_salary %>% separate(free_agency, c('agency_time', 'type'),' ')
# There's warning of NA's in the dataset

# Extract rows with NA values
player_salary_[c(which(is.na(player_salary_)==TRUE, arr.ind = TRUE)[,1]),]

# These are not top players
# the number of missing data is not very large, so we just drop  them
player_salary_ <- player_salary_[-c(which(is.na(player_salary_)==TRUE, arr.ind = TRUE)[,1]) ,]
rownames(player_salary_) <- c(1:nrow(player_salary_))

player_salary_$agency_time <- as.numeric(player_salary_$agency_time)
```
```{r}
player_salary <- player_salary_
coach_record <- coach_record_
coach_salary <- coach_salary_
```


## Topics and Analysis

# 5. How many players will be free agency by 2022?
```{r}
# Importing package
library(readxl)

# Loading dataframe
df_salaries <- read_excel("football_salaries.xls")

# Removing strings from column 
#gsub or str_replace


```
# 6. What are the 20 MVP players based on their earns?
```{r}
# Creating column with MVP value 
df_MVP <- df_salaries %>% 
  rowwise() %>% 
  mutate(MVP_value = sum(avg_year, total_guaranteed, fully_guaranteed))

# Removing duplicated players'name
df_MVP <- df_MVP %>% distinct(player, .keep_all= TRUE)

# Organizing it by sorting as ascending values
df_MVP <- df_MVP[order(df_MVP$MVP_value),]

# Extracting the 20 highest MVP_values
df_20 <- tail(df_MVP, n= 20)

# The 20 most valuable players (MVP) are: 
df_20$player

# Which position has more MVP's?
df_20$position <- as.factor(df_20$position) # making position as factor

ggplot(df_20, aes(x= position, color= position)) +
    geom_bar(stat = "count") +
    labs(x = "Position") +
  ggtitle("MVP's per position")
```
The position that shows more MVP's is the quarterback.







# 7. What teams have the highest fully guaranteed expenses?

# 8. What is the relationship between coach salaries and their records?









Your final project consists of a written report and a presentation (uploaded to VidGrid), to be turned in instead of a final exam. In this project, you will select a topic, acquire data from one or more sources, and present any interesting findings you might come across as you explore your data.

## Ground rules

-   You may work in teams of up to 3 people, but each member of the team should contribute approximately evenly (I will measure this using your git contributions)

-   Your dataset(s)

    -   should be fun (something you enjoy)!

    -   should have at least 1000 records and at least 5 variables

    -   must include at least one meaningful categorical variable and one meaningful numeric variable (these can be derived, if you are e.g. working with text or image data)

    -   must not be published in a textbook or have a published analysis unless

        -   you get prior permission and
        -   your analysis is very different from what has previously been published

    -   must be something that you can make available to the entire class (so e.g. proprietary datasets from work or other sources aren't acceptable)

    -   should be on a topic of general interest - something you could discuss with your parents or grandparents

-   You should use GitHub to track your project throughout its life cycle. You should commit your changes and push frequently, and before you start working on the project, you should pull (this will minimize merge conflicts).

-   Your work should be reproducible from start to finish. Do not modify the data by hand! I should be able to take the original data and your repository and go through your analysis from start to finish on my own machine.

-   You **should not have to do any complicated statistical modeling for this project.** Any modeling you do must be explained in a way that is comprehensible to everyone in the class (and they may not have the same background as you do!)

-   Your project should use what you have learned (and what you will learn) about data visualization, data wrangling, programming, functions, interactive graphics, and dynamic documents.

-   Your written report should be approximately $2n + 1$ pages (or $450\times(2n + 1)$ words), where $n$ is the number of people in your group. The extra page is to allow you space to describe your dataset, methods, and conclusions. The report should be grammatically correct, factually correct, with appropriate references, including to the software packages you used to create it.

-   Your presentation should include slides (made using beamer, xaringan, or another compiled document) or a poster that highlight(s) the findings you have presented in your report. Each member of your group must participate in the presentation. Your presentation should be approximately $4\times(n+1)$ minutes long.

-   You will be expected to peer-evaluate two other groups presentations and/or reports.

## Data Sources

Here are some potential sources of interesting and/or fun data:

-   [Data is Plural](https://docs.google.com/spreadsheets/d/1wZhPLMCHKJvwOkP4juclhjFgqIY8fQFMemwKL2c64vk/edit#gid=0) archive

-   [TidyTuesday Archive](https://github.com/rfordatascience/tidytuesday)

-   [Data.gov](https://catalog.data.gov/dataset) The US government data archive
